<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Conversational LMS</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">üîê Conversational LMS</div>
        <div class="nav-menu">
            <span id="user-name">User</span>
            <button id="logout-btn" class="btn-secondary">Logout</button>
        </div>
    </nav>
    
    <div class="dashboard-container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Questions</h3>
                <p class="stat-value" id="total-questions">0</p>
            </div>
            
            <div class="stat-card">
                <h3>Accuracy</h3>
                <p class="stat-value" id="accuracy">0%</p>
            </div>
            
            <div class="stat-card">
                <h3>Current Difficulty</h3>
                <p class="stat-value" id="difficulty">1.0</p>
            </div>
            
            <div class="stat-card">
                <h3>Current Streak</h3>
                <p class="stat-value" id="streak">0</p>
            </div>
        </div>
        
        <div class="action-section">
            <div class="section-header">
                <h2>üìù Start Quiz Mode</h2>
                <p class="section-subtitle">Select a topic to begin practicing with multiple-choice questions</p>
            </div>
            <div class="topics-grid" id="topics-grid">
                <!-- Topics will be loaded dynamically -->
            </div>
        </div>
        
        <div class="progress-section">
            <h2>Recent Performance</h2>
            <div id="performance-chart">
                <p class="loading">Loading analytics...</p>
            </div>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboard() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const user = await api.get('/auth/me');
                document.getElementById('user-name').textContent = user.username;
                document.getElementById('total-questions').textContent = user.total_questions;
                document.getElementById('accuracy').textContent = 
                    user.total_questions > 0 
                        ? ((user.correct_answers / user.total_questions) * 100).toFixed(1) + '%'
                        : '0%';
                document.getElementById('difficulty').textContent = user.current_difficulty.toFixed(1);
                document.getElementById('streak').textContent = user.correct_streak;
                
                // Load analytics
                const analytics = await api.get('/analytics/performance');
                if (analytics.total_questions > 0) {
                    const correctCount = Math.round(analytics.total_questions * analytics.accuracy / 100);
                    const incorrectCount = analytics.total_questions - correctCount;
                    
                    document.getElementById('performance-chart').innerHTML = `
                        <div class="analytics-summary">
                            <p>‚úÖ Correct: ${correctCount}</p>
                            <p>‚ùå Incorrect: ${incorrectCount}</p>
                            <p>üìä Average Difficulty: ${analytics.average_difficulty.toFixed(1)}</p>
                        </div>
                    `;
                }
                
                // Load available topics
                loadTopics();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            }
        }
        
        // Load available topics
        async function loadTopics() {
            try {
                const response = await api.get('/quiz/topics');
                const topicsGrid = document.getElementById('topics-grid');
                topicsGrid.innerHTML = '';
                
                response.topics.forEach(topic => {
                    const button = document.createElement('button');
                    button.className = 'topic-btn';
                    button.innerHTML = `
                        <div class="topic-icon">${topic.name.split(' ')[0]}</div>
                        <div class="topic-info">
                            <div class="topic-title">${topic.name}</div>
                            <div class="topic-description">${topic.description}</div>
                        </div>
                    `;
                    button.addEventListener('click', () => startQuiz(topic.id));
                    topicsGrid.appendChild(button);
                });
            } catch (error) {
                console.error('Error loading topics:', error);
                // Use fallback topics
                loadFallbackTopics();
            }
        }
        
        // Fallback topics if API fails
        function loadFallbackTopics() {
            const topics = [
                { id: "python_basics", name: "üêç Python Basics", description: "Learn Python fundamentals" },
                { id: "web_security", name: "üåê Web Security", description: "Secure web development" },
                { id: "networking", name: "üì° Networking", description: "Network fundamentals" },
                { id: "linux_security", name: "üêß Linux Security", description: "Linux hardening & security" },
                { id: "cryptography", name: "üîê Cryptography", description: "Encryption & hashing" },
                { id: "incident_response", name: "üö® Incident Response", description: "Handling security incidents" }
            ];
            
            const topicsGrid = document.getElementById('topics-grid');
            topicsGrid.innerHTML = '';
            
            topics.forEach(topic => {
                const button = document.createElement('button');
                button.className = 'topic-btn';
                button.innerHTML = `
                    <div class="topic-icon">${topic.name.split(' ')[0]}</div>
                    <div class="topic-info">
                        <div class="topic-title">${topic.name}</div>
                        <div class="topic-description">${topic.description}</div>
                    </div>
                `;
                button.addEventListener('click', () => startQuiz(topic.id));
                topicsGrid.appendChild(button);
            });
        }
        
        // Start quiz for selected topic
        function startQuiz(topicId) {
            window.location.href = `quiz.html?topic=${topicId}`;
        }
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });
        
        loadDashboard();
    </script>
</body>
</html>